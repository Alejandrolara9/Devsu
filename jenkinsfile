import groovy.transform.Field
import hudson.model.*
import com.google.common.io.Files
//Variables Bitbucket
def Rama = 'main'
def Repositorio  = 'https://github.com/Alejandrolara9/Devsu.git'
def credentialGitId  = 'github'
def projectName = "Devsu"
//Variable de entorno
@Field nameStage
//Variables SSH
def pathDeploy = '/home/ubuntu/Devs/'
pipeline {
    agent any
    stages {
        stage('Checkout') {
            steps {
                sh """ 
                    cd ${pathDeploy}
                    if [ -d ${projectName} ]
                    then
                        cd ${projectName}
                        git pull origin ${Rama}
                    else
                        git clone 'https://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@github.com/Alejandrolara9/Devsu.git'
                    fi
                """
            }
        }
        stage('Terraform Init') {
            steps {
                // Inicializar Terraform
                dir('terraform') {
                    sh """ 
                        cd ${pathDeploy}
                        cd ${projectName}
                        sh 'terraform init'
                        sh 'terraform plan -out=tfplan'
                        sh 'terraform apply -auto-approve tfplan'
                            
                    """
                }
            }
        }
    }
}
